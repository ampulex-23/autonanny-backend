-- ============================================================================
-- Миграция: 002_simplify_tariffs_be_mvp_011
-- Описание: Упрощение тарифов до единой категории "Заказ маршрута"
-- Задача: BE-MVP-011
-- User Story: US-ORDER-01
-- Дата: 2025-10-26
-- Автор: AutoNanny Team
-- ============================================================================

-- Начало транзакции для безопасности
BEGIN;

-- ============================================================================
-- 1. Обновление существующего тарифа "Эконом"
-- ============================================================================

UPDATE data.car_tariff
SET 
    title = 'Заказ маршрута',
    description = 'Единый тариф для всех поездок. Акцент на квалификации и опыте автоняни, а не на классе автомобиля.',
    amount = 100,  -- Оптимальная цена: 100 руб/км (среднее между эконом и комфорт)
    percent = 65,  -- Процент водителю
    "isActive" = true,
    one_time = true
WHERE id = 1;

-- ============================================================================
-- 2. Деактивация всех остальных тарифов (если есть)
-- ============================================================================

UPDATE data.car_tariff
SET "isActive" = false
WHERE id != 1;

-- ============================================================================
-- 3. Добавление комментариев для документации
-- ============================================================================

COMMENT ON COLUMN data.car_tariff.title IS 'Название тарифа (теперь единое: "Заказ маршрута")';
COMMENT ON COLUMN data.car_tariff.amount IS 'Стоимость за километр в рублях';
COMMENT ON COLUMN data.car_tariff.percent IS 'Процент от суммы заказа, который получает водитель';

-- ============================================================================
-- 4. Проверка результата
-- ============================================================================

DO $$
DECLARE
    active_tariffs_count INTEGER;
    tariff_title TEXT;
    tariff_amount INTEGER;
BEGIN
    -- Подсчет активных тарифов
    SELECT COUNT(*) INTO active_tariffs_count
    FROM data.car_tariff
    WHERE "isActive" = true;
    
    -- Получение данных единственного активного тарифа
    SELECT title, amount INTO tariff_title, tariff_amount
    FROM data.car_tariff
    WHERE id = 1;
    
    -- Проверка результата
    IF active_tariffs_count = 1 AND tariff_title = 'Заказ маршрута' AND tariff_amount = 100 THEN
        RAISE NOTICE 'Миграция успешна: активен 1 тариф "%", стоимость % руб/км', tariff_title, tariff_amount;
    ELSE
        RAISE EXCEPTION 'Ошибка миграции: активных тарифов %, название "%", стоимость %', 
                        active_tariffs_count, tariff_title, tariff_amount;
    END IF;
END $$;

-- ============================================================================
-- 5. Вывод информации о затронутых расписаниях
-- ============================================================================

SELECT 
    'Информация о расписаниях' AS info,
    COUNT(*) AS total_schedules,
    COUNT(DISTINCT id_user) AS unique_users
FROM data.schedule
WHERE id_tariff = 1;

-- ============================================================================
-- 6. Регистрация миграции в системе Aerich
-- ============================================================================

INSERT INTO aerich (version, app, content) 
VALUES (
    '2_simplify_tariffs_be_mvp_011',
    'models',
    '{
        "description": "Упрощение тарифов до единой категории Заказ маршрута",
        "changes": [
            "Переименован тариф Эконом -> Заказ маршрута",
            "Обновлена стоимость: 78 -> 100 руб/км",
            "Обновлено описание с акцентом на квалификацию",
            "Деактивированы все остальные тарифы"
        ],
        "affected_tables": ["data.car_tariff"],
        "affected_rows": 1,
        "task": "BE-MVP-011",
        "user_story": "US-ORDER-01"
    }'::jsonb
);

-- Подтверждение транзакции
COMMIT;

-- ============================================================================
-- ОТКАТ (если нужно вернуть назад)
-- ============================================================================
-- 
-- BEGIN;
-- 
-- UPDATE data.car_tariff
-- SET 
--     title = 'Эконом',
--     description = 'Тариф "Эконом"',
--     amount = 78,
--     percent = 5
-- WHERE id = 1;
-- 
-- DELETE FROM aerich WHERE version = '2_simplify_tariffs_be_mvp_011';
-- 
-- COMMIT;
-- ============================================================================

-- Финальная проверка
SELECT 
    id,
    title,
    description,
    amount AS "руб/км",
    percent AS "% водителю",
    "isActive" AS активен,
    id_franchise AS франшиза
FROM data.car_tariff
ORDER BY id;
