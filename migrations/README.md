# Система миграций базы данных

## Обзор

Проект использует **Aerich** - систему миграций для Tortoise ORM.

## Структура

```
migrations/
├── README.md           # Эта документация
├── models/            # Автогенерируемые модели (создаются Aerich)
└── sql/               # SQL скрипты для ручного применения
    ├── 001_init_aerich.sql
    └── ...
```

## Команды Aerich

### Локальная разработка

```bash
# Инициализация (уже выполнено)
aerich init -t db_config.TORTOISE_ORM

# Создание новой миграции
aerich migrate --name "description_of_changes"

# Применение миграций
aerich upgrade

# Откат последней миграции
aerich downgrade

# История миграций
aerich history
```

### Production

**ВАЖНО:** На production БД у нас read-only доступ через MCP.
Миграции применяются вручную администратором БД.

## Процесс работы с миграциями

### 1. Локальная разработка

1. Изменяете модели в `models/*.py`
2. Создаете миграцию: `aerich migrate --name "your_change"`
3. Тестируете локально: `aerich upgrade`
4. Проверяете, что всё работает

### 2. Подготовка для production

1. Экспортируйте SQL из миграции Aerich
2. Сохраните в `migrations/sql/XXX_description.sql`
3. Добавьте в git
4. Создайте PR с описанием изменений

### 3. Применение на production

1. Администратор БД получает SQL скрипт
2. Проверяет на staging (если есть)
3. Применяет на production вручную
4. Обновляет таблицу `aerich` для отслеживания версии

## Текущее состояние

- ✅ Aerich установлен и настроен
- ✅ Конфигурация в `db_config.py`
- ⏳ Начальная миграция (snapshot) - в процессе
- ⏳ Таблица `aerich` на production - требует создания

## Следующие шаги

1. Создать таблицу `aerich` на production
2. Создать начальную миграцию (snapshot текущей схемы)
3. Зарегистрировать её в таблице `aerich`
